{{ $slideWidth := .Get "slidewidth" }}
{{ if not $slideWidth }}
  {{ $slideWidth = "100%" }}
{{ end }}
{{ $mainCaption := .Get "caption" }}

{{/* Generate unique ID - use provided id or create one from ordinal */}}
{{ $slideshowId := .Get "id" }}
{{ if not $slideshowId }}
  {{ $slideshowId = printf "slideshow-%d" .Ordinal }}
{{ end }}

<style>
.slideshow-container-{{ $slideshowId }} {
  position: relative;
  width: {{ $slideWidth }};
  max-width: 100% !important;
  margin: 0 auto;
}

.slideshow-container-{{ $slideshowId }} .slide {
  display: none;
  border-radius: 8px;
}

.slideshow-container-{{ $slideshowId }} .slide.active {
  display: block;
}

.slideshow-container-{{ $slideshowId }} .nav-btn {
  background-color: black;
  color: white;
  border: none;
  padding: 8px;
  cursor: pointer;
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  z-index: 2;
}

.slideshow-container-{{ $slideshowId }} .nav-btn.prev { left: 0; }
.slideshow-container-{{ $slideshowId }} .nav-btn.next { right: 0; }

.slideshow-container-{{ $slideshowId }} .slide-caption {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 12px;
  text-align: center;
  font-style: italic;
  border-radius: 0 0 8px 8px;
}

.slideshow-container-{{ $slideshowId }} .main-caption {
  text-align: center;
  font-weight: bold;
  margin-top: 0.5rem;
}

.main-caption {
  text-align: center;
  font-weight: bold;
  margin-top: 0.5rem;
}
</style>
{{ $maxSize:= .Site.Params.slideshow.maxSize}}

<div class="slideshow-container-{{ $slideshowId }}" data-slideshow-id="{{ $slideshowId }}">
  {{ range $index := seq 1 $maxSize }}
    {{ $imageParam := print "image" $index }}
    {{ $captionParam := print "caption" $index }}
    {{ $imagePath := $.Get $imageParam }}

    {{ if $imagePath }}
      {{ $finalPath := "" }}

  
      {{ $clean := strings.TrimPrefix "/" $imagePath }}
      {{ $clean = strings.TrimPrefix "\\" $clean }}

      {{ $pageImg := $.Page.Resources.GetMatch $clean }}

      {{ if $pageImg }}
        {{ $finalPath = $pageImg.RelPermalink }}

      {{ else }}

        {{ if (strings.HasPrefix $clean "images/") }}
          {{ $assetImage := resources.Get (printf "images/%s" (strings.TrimPrefix "images/" $clean)) }}

          {{ if $assetImage }}
            {{ $finalPath = $assetImage.RelPermalink }}
          {{ else }}
            {{ $finalPath = printf "/%s" $clean }}
          {{ end }}

        {{ else }}

          {{ if not (hasPrefix $imagePath "/") }}
            {{ $finalPath = printf "/%s" $imagePath }}
          {{ else }}
            {{ $finalPath = $imagePath }}
          {{ end }}

        {{ end }}
      {{ end }}

      <div class="slide" data-slide-index="{{ $index }}">
        <img src="{{ $finalPath | relURL }}" alt="Slideshow image" style="width: 100%; border-radius: 8px;">
        {{ $slideCaption := $.Get $captionParam }}
        {{ if $slideCaption }}
          <div class="slide-caption">{{ $slideCaption }}</div>
        {{ end }}
      </div>
    {{ end }}
  {{ end }}

  <button class="nav-btn prev" onclick="changeSlide('{{ $slideshowId }}', -1)">&#10094;</button>
  <button class="nav-btn next" onclick="changeSlide('{{ $slideshowId }}', 1)">&#10095;</button>
</div>

{{ if $mainCaption }}
  <p class="main-caption">{{ $mainCaption }}</p>
{{ end }}

<script>
(function() {
  if (!window.slideshowStates) {
    window.slideshowStates = {};
    
    window.changeSlide = function(id, direction) {
      const state = window.slideshowStates[id];
      if (!state) return;
      state.currentIndex += direction;
      showSlide(id);
    };
    
    window.showSlide = function(id) {
      const state = window.slideshowStates[id];
      if (!state) return;
      const slides = state.container.querySelectorAll('.slide');
      if (slides.length === 0) return;
      if (state.currentIndex > slides.length) state.currentIndex = 1;
      if (state.currentIndex < 1) state.currentIndex = slides.length;
      slides.forEach(slide => slide.classList.remove('active'));
      slides[state.currentIndex - 1].classList.add('active');
    };
  }
  
  const id = '{{ $slideshowId }}';
  const container = document.querySelector('.slideshow-container-' + id);
  
  if (container && !window.slideshowStates[id]) {
    window.slideshowStates[id] = {
      container: container,
      currentIndex: 1
    };
    window.showSlide(id);
  }
})();
</script>
